<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Smart Health</title>
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/css/bootstrap-grid.css">
    <link rel="stylesheet" href="assets/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="assets/css/sb-admin-2.css">
    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <script src="assets/js/angular.js"></script>
    <script src="assets/js/angular-animate.js"></script>
    <script src="assets/js/bootstrap.bundle.js"></script>
    <script src="assets/js/angular-route.min.js"></script>
    <script src="assets/js/bootstrap.js"></script>
    <script src="assets/js/Chart.min.js"></script>
    <script src="assets/js/Chart.bundle.min.js"></script>
    <script src="assets/js/mqttws31.min.js"></script>
    <script src="app.js"></script>
<script>
    $(document).ready(function(){
        createDB();
    });
    let db = null;
    let mqtt = new Paho.MQTT.Client("127.0.0.1",1884,"IOT-ESP");




    function viewNotes() {
        const tx = db.transaction("health_conditions","readonly");
        const pNotes = tx.objectStore("health_conditions");
        const request = pNotes.openCursor();
        request.onsuccess = e => {

            const cursor = e.target.result;

            if (cursor) {

                alert(`Title: ${cursor.key} Text: ${cursor.value.from_problem} `);
                //do something with the cursor
                cursor.continue()
            }
        }

    }



    function getAllFromDose() {
        const tx = db.transaction("dose_drug","readonly");
        const pNotes = tx.objectStore("dose_drug");
        const request = pNotes.openCursor();
        request.onsuccess = e => {

            const cursor = e.target.result;

            if (cursor) {
                addNewValueDoseTable(unixToDate(cursor.value.date) ,cursor.value.dose_drug);
                cursor.continue()
            }
        }
    }


    function addAilment(from_p, to_p, type_d) {
        const  data= {
            id:new Date().getTime(),
            date: new Date().getTime(),
            from_problem: from_p.toString(),
            to_problem: to_p.toString(),
            type_of_disease: type_d.toString()
        };
        const save = db.transaction("health_conditions", "readwrite");
        save.onerror = e => alert( ` Error! ${e.target.error}`);
        const temp_data = save.objectStore("health_conditions");
        temp_data.add(data)
    }

    function addDoseDrug (dose_d) {
        const data = {
            id:new Date().getTime(),
            date: new Date().getTime(),
            dose_drug: dose_d
        };
        const save = db.transaction("dose_drug", "readwrite");
        save.onerror = e => alert( ` Error! ${e.target.error}`);
        const temp_data = save.objectStore("dose_drug");
        temp_data.add(data)
    }

    function createDB () {
        const request = indexedDB.open("sh_db",1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            const hc = db.createObjectStore("health_conditions", {keyPath: "id"});
            const dd = db.createObjectStore("dose_drug", {keyPath: "id"});
            alert(`Zaktualizowano bazę: ${db.name} o wersji: ${db.version}`);
        };
        request.onsuccess = e => {
            db = e.target.result;
            console.log()
            alert(`Tworzono bazę danych: ${db.name} o wersji : ${db.version}`);
        };
        request.onerror = e => {
            alert(`Problem: ${e.target.error}`);
        }
    }








    function update(chart, label, data) {
        chart.data.datasets[label].data.push(data);
        chart.update();
    }

    mqtt.onMessageArrived = function (data) {
        console.log(data.destinationName);

        const object = data.payloadString;
        console.log(object);

        try {
            update(myLineChart,0,90);
        }
        catch(err) {
            console.log(err.message);
        }
        try {
            update(myLineChart,1,70);
        }
        catch(err) {
            console.log(err.message);
        }
    };
    mqtt.connect(
        {
            onSuccess: function () {
                mqtt.subscribe("IOT-ESP");
            }
        }
    );




    function addNewValueAilmentsTable(from_p, to_p, type_d){
        var markup = "<tr role=\"row\"><td>" + from_p + "</td><td>" + to_p + "</td><td>" + type_d + "</td></tr>";
        $("#ailments_table").append(markup);
    }
    function addNewValueDoseTable(date_d,dose_d){
        var markup = "<tr role=\"row\"><td>" + date_d + "</td><td>" + dose_d + "</td></tr>";
        $("#dose_table").append(markup);
    }




    //Adding button handling
    function sendMessage(value) {
        let message;
        switch(value) {
            case 0:
                message = new Paho.MQTT.Message("0");
                addDoseDrug(0);
                break;
            case 1:
                message = new Paho.MQTT.Message("1");
                addDoseDrug(1);
                break;
            case 2:
                message = new Paho.MQTT.Message("2");
                addDoseDrug(2);
                break;
            default:
                message = new Paho.MQTT.Message("0");
                addDoseDrug(2);
        }
        message.destinationName = "WEB-ESP";
        mqtt.send(message);
    }





    function unixToDate(UNIX_timestamp){
        const a = new Date(UNIX_timestamp * 1000);
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const year = a.getFullYear();
        const month = months[a.getMonth()];
        const date = a.getDate();
        const hour = a.getHours();
        const min = a.getMinutes();
        const sec = a.getSeconds();
        return date + ' ' + month + ' ' + year + ' ' + hour + ':' + min + ':' + sec;
    }





</script>
</head>
<body id="page-top">
<div ng-app="myApp" ng-controller="MultiController" id="wrapper">
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-laugh-wink"></i>
            </div>
            <div class="sidebar-brand-text mx-3"> Smart Health</div>
        </a>
        <hr class="sidebar-divider my-0">
        <li class="nav-item active">
            <a class="nav-link" href="#!patient">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>{{bar_patient_page}}</span></a>
        </li>
        <li class="nav-item active">
            <a class="nav-link" href="#!doctor">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>{{bar_doctor_page}}</span></a>
        </li>
    </ul>
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <ul class="navbar-nav ml-auto">
                    <div class="topbar-divider d-none d-sm-block"></div>
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{doctor_name}}</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="container-fluid">
                <div ng-view></div>
            </div>
        </div>
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>{{footer}}</span>
                </div>
            </div>
        </footer>
    </div>
</div>
</body>
</html>
