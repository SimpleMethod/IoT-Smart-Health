<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Smart Health</title>
    <link rel="stylesheet" href="assets/css/bootstrap.css">
    <link rel="stylesheet" href="assets/css/bootstrap-grid.css">
    <link rel="stylesheet" href="assets/css/bootstrap-reboot.css">
    <link rel="stylesheet" href="assets/css/sb-admin-2.css">
    <script src="assets/js/jquery-3.3.1.min.js"></script>
    <script src="assets/js/angular.js"></script>
    <script src="assets/js/angular-animate.js"></script>
    <script src="assets/js/bootstrap.bundle.js"></script>
    <script src="assets/js/angular-route.min.js"></script>
    <script src="assets/js/bootstrap.js"></script>
    <script src="assets/js/Chart.min.js"></script>
    <script src="assets/js/Chart.bundle.min.js"></script>
    <script src="assets/js/mqttws31.min.js"></script>
<script>
    var app = angular.module("myApp", ["ngRoute"]).controller("MultiController");
    app.config(function($routeProvider) {
        $routeProvider

            .when("/", {
                templateUrl : 'pages/home.html'
             //   controller: 'MultiController'
            })
            .when("/patient", {
                templateUrl : 'pages/patient.html'
             //   controller: 'MultiController'
            })
            .when("/doctor", {
                templateUrl : 'pages/doctor.html'
               // controller: 'MultiController'
            });
    });



    var PL = {
        "doctor_name": "Jan Noowak",
        "footer": "Copyright ©M&N 2019",
        "index_main_container": "Projekt interfejsu do projektu Smart Health",
        "index_main_container_samll": "Klient ogólnego przeznaczenia, do zarządzania pacjentem.",
        "bar_patient_page": "Strona pacjenta",
        "bar_doctor_page": "Strona lekarza",
        "patient_page_title": "Strona pacjenta",
        "patient_page_reported_ailments": "Zgłoszone dolegliwości",
        "patient_page_from": "Od",
        "patient_page_to": "Do",
        "patient_page_type_of_ailments": "Rodzaj dolegliwości",
        "patient_page_date": "Data",
        "patient_page_a_doses_of_medicines": "Dawka leku",
        "patient_page_doses_of_medicines": "Dawki leku",
        "patient_page_graph_of_vital_signs": "Wykres funkcji życiowych",
        "doctor_page_title": "Strona lekarza",
        "doctor_page_information_about_patient": "Informacja o pacjencie",
        "doctor_page_information_dosage": "Dawkowanie",
        "doctor_page_ip_address": "IP:",
        "doctor_page_ip_patient": "Pacjent:",
        "doctor_page_temp_patient": "Temperatura ciała:",
        "doctor_page_pulse_patient": "Puls:",
        "doctor_page_0_tablets": "Brak tabletek",
        "doctor_page_1_tablets": "Jedna tabletek",
        "doctor_page_2_tablets":"Dwie tabletki"
    };


    app.controller('MultiController', function ($scope) {
        $scope.doctor_name = PL.doctor_name;
        $scope.footer = PL.footer;
        $scope.index_main_container = PL.index_main_container;
        $scope.index_main_container_samll = PL.index_main_container_samll;
        $scope.bar_patient_page = PL.bar_patient_page;
        $scope.bar_doctor_page = PL.bar_doctor_page;
        $scope.patient_page_title = PL.patient_page_title;
        $scope.patient_page_reported_ailments = PL.patient_page_reported_ailments;
        $scope.patient_page_from = PL.patient_page_from;
        $scope.patient_page_to = PL.patient_page_to;
        $scope.patient_page_type_of_ailments = PL.patient_page_type_of_ailments;
        $scope.patient_page_date = PL.patient_page_date;
        $scope.patient_page_a_doses_of_medicines = PL.patient_page_a_doses_of_medicines;
        $scope.patient_page_doses_of_medicines = PL.patient_page_doses_of_medicines;
        $scope.patient_page_graph_of_vital_signs = PL.patient_page_graph_of_vital_signs;
        $scope.doctor_page_title = PL.doctor_page_title;
        $scope.doctor_page_reported_title = PL.doctor_page_reported_title;
        $scope.doctor_page_information_about_patient = PL.doctor_page_information_about_patient;
        $scope.doctor_page_information_dosage = PL.doctor_page_information_dosage;
        $scope.doctor_page_ip_address = PL.doctor_page_ip_address;
        $scope.doctor_page_ip_patient = PL.doctor_page_ip_patient;
        $scope.doctor_page_temp_patient = PL.doctor_page_temp_patient;
        $scope.doctor_page_pulse_patient = PL.doctor_page_pulse_patient;
        $scope.doctor_page_0_tablets = PL.doctor_page_0_tablets;
        $scope.doctor_page_1_tablets = PL.doctor_page_1_tablets;
        $scope.doctor_page_2_tablets = PL.doctor_page_2_tablets;
    });


    app.controller('myController', function ($scope) {

        // JSON ARRAY TO POPULATE TABLE.
        $scope.doseArray =
            [
                { 'name': 'dfsdsdfsdf Eclipse', 'director': 'Agniezka Hollan' },
                { 'name': 'My Left Foot', 'director': 'Jim Sheridan' },
                { 'name': 'Forest Gump', 'director': 'Robert Zemeckis' }
            ];

        // GET VALUES FROM INPUT BOXES AND ADD A NEW ROW TO THE TABLE.
        $scope.addRow = function () {
            if ($scope.name != undefined && $scope.director != undefined) {
                var movie = [];
                dose.name = $scope.name;
                dose.director = $scope.director;

                $scope.doseArray.push(movie);

                // CLEAR TEXTBOX.
                $scope.name = null;
                $scope.director = null;
            }
        };

        // REMOVE SELECTED ROW(s) FROM TABLE.
        $scope.removeRow = function () {
            var arrMovie = [];
            angular.forEach($scope.movieArray, function (value) {
                if (!value.Remove) {
                    arrMovie.push(value);
                }
            });
            $scope.movieArray = arrMovie;
        };

        // FINALLY SUBMIT THE DATA.
        $scope.submit = function () {
            var arrMovie = [];
            angular.forEach($scope.movieArray, function (value) {
                arrMovie.push('Name:' + value.name + ', Director:' + value.director);
            });
            $scope.display = arrMovie;
        };
    });












    let db = null;
    function viewNotes() {

        const tx = db.transaction("health_conditions","readonly");
        const pNotes = tx.objectStore("health_conditions");
        const request = pNotes.openCursor();
        request.onsuccess = e => {

            const cursor = e.target.result;

            if (cursor) {
                alert(`Title: ${cursor.key} Text: ${cursor.value.from_problem} `);
                //do something with the cursor
                cursor.continue()
            }
        }

    }




    function addAilment(from_p, to_p, type_d) {
        const  data= {
            id:new Date().getTime(),
            date: new Date().getTime(),
            from_problem: from_p.toString(),
            to_problem: to_p.toString(),
            type_of_disease: type_d.toString()
        };
        const save = db.transaction("health_conditions", "readwrite");
        save.onerror = e => alert( ` Error! ${e.target.error}`);
        const temp_data = save.objectStore("health_conditions");
        temp_data.add(data)
    }

    function AddDoseDrug (dose_d) {
        const data = {
            id:new Date().getTime(),
            date: new Date().getTime(),
            dose_drug: dose_d
        };
        const save = db.transaction("dose_drug", "readwrite");
        save.onerror = e => alert( ` Error! ${e.target.error}`);
        const temp_data = save.objectStore("dose_drug");
        temp_data.add(data)
    }

    function createDB () {
        const request = indexedDB.open("sh_db",1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            const hc = db.createObjectStore("health_conditions", {keyPath: "id"});
            const dd = db.createObjectStore("dose_drug", {keyPath: "id"});
            alert(`Zaktualizowano bazę: ${db.name} o wersji: ${db.version}`);
        };
        request.onsuccess = e => {
            db = e.target.result;
            console.log()
            alert(`Tworzono bazę danych: ${db.name} o wersji : ${db.version}`);
        };
        request.onerror = e => {
            alert(`Problem: ${e.target.error}`);
        }
    }


    createDB();
    let mqtt = new Paho.MQTT.Client("127.0.0.1",1884,"IOT-ESP");

    function update(chart, label, data) {
        chart.data.datasets[label].data.push(data);
        chart.update();
    }

    mqtt.onMessageArrived = function (data) {
        console.log(data.destinationName);

        const object = data.payloadString;
        console.log(object);

        try {
            update(myLineChart,0,90);
        }
        catch(err) {
            console.log(err.message);
        }
        try {
            update(myLineChart,1,70);
        }
        catch(err) {
            console.log(err.message);
        }
    };
    mqtt.connect(
        {
            onSuccess: function () {
                mqtt.subscribe("IOT-ESP");
            }
        }
    );

    //Adding button handling
    function sendMessage(value) {
        let message;
        switch(value) {
            case 0:
                message = new Paho.MQTT.Message("0");
                AddDoseDrug(0);
                break;
            case 1:
                message = new Paho.MQTT.Message("1");
                AddDoseDrug(1);
                break;
            case 2:
                message = new Paho.MQTT.Message("2");
                AddDoseDrug(2);
                break;
            default:
                message = new Paho.MQTT.Message("0");
                AddDoseDrug(2);
        }
        message.destinationName = "WEB-ESP";
        mqtt.send(message);
    }


</script>
</head>
<body id="page-top">
<div ng-app="myApp" ng-controller="MultiController" id="wrapper">
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon rotate-n-15">
                <i class="fas fa-laugh-wink"></i>
            </div>
            <div class="sidebar-brand-text mx-3"> Smart Health</div>
        </a>
        <hr class="sidebar-divider my-0">
        <li class="nav-item active">
            <a class="nav-link" href="#!patient">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>{{bar_patient_page}}</span></a>
        </li>
        <li class="nav-item active">
            <a class="nav-link" href="#!doctor">
                <i class="fas fa-fw fa-tachometer-alt"></i>
                <span>{{bar_doctor_page}}</span></a>
        </li>
    </ul>
    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <ul class="navbar-nav ml-auto">
                    <div class="topbar-divider d-none d-sm-block"></div>
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small">{{doctor_name}}</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="container-fluid">
                <div ng-view></div>
            </div>
        </div>
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>{{footer}}</span>
                </div>
            </div>
        </footer>
    </div>
</div>
</body>
</html>
